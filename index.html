<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ICOK Fund â€” íˆ¬ìì ê³µì‹œ</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<style>
  :root {
    --bg:       #0d0f14;
    --surface:  #161a22;
    --border:   #242936;
    --accent:   #c8a96e;
    --accent2:  #e6c98a;
    --text:     #e8ecf4;
    --muted:    #6b7280;
    --pos:      #3dd68c;
    --neg:      #ff5c5c;
    --us-blue:  #4fa3e0;
    --radius:   12px;
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Pretendard', -apple-system, 'Noto Sans KR', sans-serif;
    font-size: 14px;
    line-height: 1.6;
    min-height: 100vh;
  }

  /* â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  header {
    background: linear-gradient(135deg, #0d0f14 0%, #1a1f2e 100%);
    border-bottom: 1px solid var(--border);
    padding: 20px 32px;
    display: flex;
    align-items: center;
    justify-content: space-between;
    position: sticky;
    top: 0;
    z-index: 100;
    backdrop-filter: blur(8px);
  }

  .logo {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .logo-icon {
    width: 42px;
    height: 42px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    border-radius: 10px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
    font-weight: 900;
    color: #0d0f14;
    letter-spacing: -1px;
  }

  .logo-text h1 {
    font-size: 18px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: 0.5px;
  }

  .logo-text p {
    font-size: 11px;
    color: var(--muted);
    margin-top: 1px;
  }

  .header-right {
    text-align: right;
  }

  .header-right .last-updated {
    font-size: 11px;
    color: var(--muted);
  }

  #status-badge {
    display: inline-flex;
    align-items: center;
    gap: 5px;
    font-size: 11px;
    padding: 3px 10px;
    border-radius: 20px;
    margin-bottom: 4px;
  }

  .badge-live {
    background: rgba(61,214,140,0.15);
    color: var(--pos);
    border: 1px solid rgba(61,214,140,0.3);
  }

  .badge-error {
    background: rgba(255,92,92,0.15);
    color: var(--neg);
    border: 1px solid rgba(255,92,92,0.3);
  }

  .badge-loading {
    background: rgba(200,169,110,0.15);
    color: var(--accent);
    border: 1px solid rgba(200,169,110,0.3);
  }

  .dot {
    width: 6px;
    height: 6px;
    border-radius: 50%;
    background: currentColor;
    animation: pulse 2s infinite;
  }

  @keyframes pulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* â”€â”€ Layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  main {
    max-width: 1400px;
    margin: 0 auto;
    padding: 28px 24px 60px;
  }

  /* â”€â”€ Error Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #error-banner {
    display: none;
    background: rgba(255,92,92,0.1);
    border: 1px solid rgba(255,92,92,0.3);
    border-radius: var(--radius);
    padding: 12px 20px;
    margin-bottom: 24px;
    font-size: 13px;
    color: var(--neg);
  }

  /* â”€â”€ Section Title â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .section-title {
    display: flex;
    align-items: center;
    gap: 10px;
    margin-bottom: 16px;
    margin-top: 36px;
  }

  .section-title h2 {
    font-size: 16px;
    font-weight: 700;
    color: var(--text);
  }

  .section-title .tag {
    font-size: 10px;
    padding: 2px 8px;
    border-radius: 4px;
    background: rgba(200,169,110,0.15);
    color: var(--accent);
    border: 1px solid rgba(200,169,110,0.25);
    letter-spacing: 0.5px;
  }

  /* â”€â”€ KPI Cards â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .kpi-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 16px;
    margin-bottom: 4px;
  }

  .kpi-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px 22px;
    position: relative;
    overflow: hidden;
    transition: border-color 0.2s, transform 0.2s;
  }

  .kpi-card:hover {
    border-color: rgba(200,169,110,0.4);
    transform: translateY(-2px);
  }

  .kpi-card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 2px;
    background: linear-gradient(90deg, var(--accent), transparent);
  }

  .kpi-card.pos-card::before { background: linear-gradient(90deg, var(--pos), transparent); }
  .kpi-card.neg-card::before { background: linear-gradient(90deg, var(--neg), transparent); }
  .kpi-card.blue-card::before { background: linear-gradient(90deg, var(--us-blue), transparent); }

  .kpi-label {
    font-size: 11px;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.8px;
    margin-bottom: 10px;
  }

  .kpi-value {
    font-size: 24px;
    font-weight: 700;
    color: var(--text);
    letter-spacing: -0.5px;
    line-height: 1.2;
  }

  .kpi-value.pos { color: var(--pos); }
  .kpi-value.neg { color: var(--neg); }
  .kpi-value.accent { color: var(--accent); }

  .kpi-sub {
    font-size: 11px;
    color: var(--muted);
    margin-top: 6px;
  }

  .kpi-icon {
    position: absolute;
    top: 18px;
    right: 18px;
    font-size: 22px;
    opacity: 0.2;
  }

  /* â”€â”€ Portfolio Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .table-wrapper {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    overflow: hidden;
    margin-bottom: 20px;
  }

  .table-header {
    padding: 14px 20px;
    border-bottom: 1px solid var(--border);
    display: flex;
    align-items: center;
    justify-content: space-between;
  }

  .table-header-left {
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .market-badge {
    font-size: 10px;
    font-weight: 700;
    padding: 2px 8px;
    border-radius: 4px;
    letter-spacing: 0.5px;
  }

  .kr-badge {
    background: rgba(200,169,110,0.2);
    color: var(--accent);
    border: 1px solid rgba(200,169,110,0.3);
  }

  .us-badge {
    background: rgba(79,163,224,0.2);
    color: var(--us-blue);
    border: 1px solid rgba(79,163,224,0.3);
  }

  .table-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
  }

  table {
    width: 100%;
    border-collapse: collapse;
  }

  thead th {
    padding: 10px 14px;
    font-size: 10px;
    font-weight: 600;
    color: var(--muted);
    text-transform: uppercase;
    letter-spacing: 0.6px;
    text-align: right;
    background: rgba(255,255,255,0.02);
    border-bottom: 1px solid var(--border);
  }

  thead th:first-child { text-align: left; }
  thead th:nth-child(2) { text-align: left; }

  tbody tr {
    border-bottom: 1px solid rgba(255,255,255,0.04);
    transition: background 0.15s;
  }

  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: rgba(255,255,255,0.03); }

  tbody td {
    padding: 12px 14px;
    font-size: 13px;
    text-align: right;
    color: var(--text);
  }

  tbody td:first-child { text-align: left; font-weight: 600; }
  tbody td:nth-child(2) { text-align: left; }

  .ticker-chip {
    font-size: 10px;
    padding: 2px 6px;
    border-radius: 4px;
    background: rgba(255,255,255,0.07);
    color: var(--muted);
    font-family: monospace;
    letter-spacing: 0.3px;
  }

  .sector-chip {
    font-size: 10px;
    padding: 2px 7px;
    border-radius: 4px;
    background: rgba(200,169,110,0.12);
    color: var(--accent);
    border: 1px solid rgba(200,169,110,0.2);
  }

  .pos-text { color: var(--pos) !important; }
  .neg-text { color: var(--neg) !important; }
  .muted-text { color: var(--muted); }

  .subtotal-row {
    background: rgba(255,255,255,0.03) !important;
  }

  .subtotal-row td {
    font-weight: 600;
    font-size: 12px;
    color: var(--muted);
    padding: 10px 14px;
    border-top: 1px solid var(--border);
  }

  /* â”€â”€ Two-column layout â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .two-col {
    display: grid;
    grid-template-columns: 1fr 1.6fr;
    gap: 20px;
    align-items: start;
  }

  @media (max-width: 900px) {
    .two-col { grid-template-columns: 1fr; }
  }

  /* â”€â”€ Sector Chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .chart-card {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: var(--radius);
    padding: 20px;
  }

  .chart-card-title {
    font-size: 13px;
    font-weight: 600;
    color: var(--text);
    margin-bottom: 16px;
    padding-bottom: 12px;
    border-bottom: 1px solid var(--border);
  }

  .chart-container {
    position: relative;
    height: 240px;
    display: flex;
    justify-content: center;
  }

  /* â”€â”€ Sector Table â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .sector-list { width: 100%; }

  .sector-row {
    display: flex;
    align-items: center;
    gap: 12px;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }

  .sector-row:last-child { border-bottom: none; }

  .sector-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .sector-name {
    flex: 1;
    font-size: 13px;
    color: var(--text);
  }

  .sector-bar-wrap {
    width: 100px;
    height: 4px;
    background: rgba(255,255,255,0.08);
    border-radius: 2px;
    overflow: hidden;
  }

  .sector-bar {
    height: 100%;
    border-radius: 2px;
    transition: width 0.8s ease;
  }

  .sector-pct {
    width: 44px;
    text-align: right;
    font-size: 12px;
    font-weight: 600;
    color: var(--accent);
  }

  .sector-amount {
    width: 90px;
    text-align: right;
    font-size: 11px;
    color: var(--muted);
  }

  /* â”€â”€ Transaction Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .tx-row td {
    font-size: 12px;
  }

  .tx-buy { color: var(--pos); font-weight: 600; }
  .tx-sell { color: var(--neg); font-weight: 600; }

  /* â”€â”€ Loading Skeleton â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .skeleton {
    background: linear-gradient(90deg, var(--border) 25%, rgba(255,255,255,0.07) 50%, var(--border) 75%);
    background-size: 400% 100%;
    animation: shimmer 1.5s infinite;
    border-radius: 4px;
    height: 16px;
  }

  @keyframes shimmer {
    0% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }

  /* â”€â”€ Footer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  footer {
    text-align: center;
    padding: 24px;
    border-top: 1px solid var(--border);
    color: var(--muted);
    font-size: 11px;
    margin-top: 40px;
    line-height: 2;
  }

  footer a { color: var(--accent); text-decoration: none; }
  footer a:hover { text-decoration: underline; }

  /* â”€â”€ Responsive â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  @media (max-width: 768px) {
    header { padding: 14px 16px; }
    main { padding: 20px 12px 40px; }
    .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 10px; }
    .kpi-value { font-size: 18px; }
    thead th:nth-child(n+5):not(:last-child) { display: none; }
    tbody td:nth-child(n+5):not(:last-child) { display: none; }
  }

  /* â”€â”€ Divider â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  .divider {
    height: 1px;
    background: var(--border);
    margin: 32px 0;
  }

  /* â”€â”€ Config Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
  #config-panel {
    background: var(--surface);
    border: 1px solid rgba(200,169,110,0.3);
    border-radius: var(--radius);
    padding: 20px;
    margin-bottom: 24px;
  }

  #config-panel h3 {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent);
    margin-bottom: 12px;
  }

  .config-row {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
  }

  .config-row label {
    font-size: 12px;
    color: var(--muted);
    white-space: nowrap;
  }

  .config-row input {
    flex: 1;
    min-width: 200px;
    background: var(--bg);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 8px 12px;
    color: var(--text);
    font-size: 13px;
    font-family: monospace;
    outline: none;
    transition: border-color 0.2s;
  }

  .config-row input:focus {
    border-color: var(--accent);
  }

  .btn {
    padding: 8px 18px;
    background: linear-gradient(135deg, var(--accent), var(--accent2));
    color: #0d0f14;
    border: none;
    border-radius: 8px;
    font-size: 13px;
    font-weight: 600;
    cursor: pointer;
    transition: opacity 0.2s;
    white-space: nowrap;
  }

  .btn:hover { opacity: 0.85; }
</style>
</head>
<body>

<!-- â”€â”€ Header â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<header>
  <div class="logo">
    <div class="logo-icon">IC</div>
    <div class="logo-text">
      <h1>ICOK Fund</h1>
      <p>íˆ¬ìì ê³µì‹œ ëŒ€ì‹œë³´ë“œ</p>
    </div>
  </div>
  <div class="header-right">
    <div id="status-badge" class="badge-loading">
      <span class="dot"></span>
      <span id="status-text">ë°ì´í„° ë¡œë”© ì¤‘...</span>
    </div>
    <div class="last-updated">
      ìµœì¢… ì—…ë°ì´íŠ¸: <span id="update-time">â€”</span>
    </div>
  </div>
</header>

<main>

  <!-- â”€â”€ Config Panel â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="config-panel">
    <h3>âš™ï¸ Google Sheets ì—°ê²° ì„¤ì •</h3>
    <div class="config-row">
      <label>ì‹œíŠ¸ ID:</label>
      <input type="text" id="sheet-id-input"
             placeholder="ìŠ¤í”„ë ˆë“œì‹œíŠ¸ ID ì…ë ¥ (URLì—ì„œ /d/ ì´í›„ ë¶€ë¶„)"
             value="">
      <button class="btn" onclick="applySheetId()">ì—°ê²°</button>
    </div>
    <p style="font-size:11px; color:var(--muted); margin-top:8px;">
      êµ¬ê¸€ ì‹œíŠ¸ URL: <code style="color:var(--accent)">https://docs.google.com/spreadsheets/d/<strong>[ì—¬ê¸°ê°€ ID]</strong>/edit</code>
      â€” ì‹œíŠ¸ëŠ” <strong>ë§í¬ê°€ ìˆëŠ” ëª¨ë“  ì‚¬ìš©ì â†’ ë·°ì–´</strong> ê³µê°œ ì„¤ì • í•„ìš”
    </p>
  </div>

  <!-- â”€â”€ Error Banner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div id="error-banner">
    âš ï¸ êµ¬ê¸€ ì‹œíŠ¸ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤. ìƒ˜í”Œ ë°ì´í„°ë¡œ í‘œì‹œë©ë‹ˆë‹¤.
    ì‹œíŠ¸ê°€ ê³µê°œ ì„¤ì •ë˜ì–´ ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”.
  </div>

  <!-- â”€â”€ KPI Section â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section-title" style="margin-top:8px;">
    <h2>í€ë“œ í˜„í™©</h2>
    <span class="tag">OVERVIEW</span>
  </div>

  <div class="kpi-grid">
    <div class="kpi-card">
      <div class="kpi-icon">ğŸ’¼</div>
      <div class="kpi-label">í€ë“œ ì´ ê·œëª¨ (AUM)</div>
      <div class="kpi-value accent" id="kpi-aum">â€”</div>
      <div class="kpi-sub" id="kpi-aum-sub">ë¡œë”© ì¤‘...</div>
    </div>
    <div class="kpi-card" id="kpi-pl-card">
      <div class="kpi-icon">ğŸ“ˆ</div>
      <div class="kpi-label">í‰ê°€ ì†ìµ</div>
      <div class="kpi-value" id="kpi-pl">â€”</div>
      <div class="kpi-sub" id="kpi-pl-sub">â€”</div>
    </div>
    <div class="kpi-card" id="kpi-return-card">
      <div class="kpi-icon">ğŸ¯</div>
      <div class="kpi-label">ìˆ˜ìµë¥ </div>
      <div class="kpi-value" id="kpi-return">â€”</div>
      <div class="kpi-sub">ì´ ë§¤ì… ëŒ€ë¹„</div>
    </div>
    <div class="kpi-card blue-card">
      <div class="kpi-icon">ğŸ’µ</div>
      <div class="kpi-label">USD/KRW í™˜ìœ¨</div>
      <div class="kpi-value" id="kpi-fx">â€”</div>
      <div class="kpi-sub" id="kpi-cash">ì˜ˆìˆ˜ê¸ˆ ë¡œë”© ì¤‘</div>
    </div>
  </div>

  <!-- â”€â”€ Korean Portfolio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section-title">
    <h2>êµ­ë‚´ í¬íŠ¸í´ë¦¬ì˜¤</h2>
    <span class="tag">KRW</span>
  </div>

  <div class="table-wrapper">
    <div class="table-header">
      <div class="table-header-left">
        <span class="market-badge kr-badge">KR</span>
        <span class="table-title">í•œêµ­ ì£¼ì‹</span>
      </div>
      <div style="font-size:11px; color:var(--muted);" id="kr-subtotal-header">â€”</div>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>ì¢…ëª©ëª…</th>
            <th>í‹°ì»¤</th>
            <th>ì„¹í„°</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>í‰ê· ë‹¨ê°€</th>
            <th>í˜„ì¬ê°€</th>
            <th>ì´ ë§¤ì…</th>
            <th>í‰ê°€ê¸ˆì•¡</th>
            <th>ì†ìµ</th>
            <th>ìˆ˜ìµë¥ </th>
            <th>ë¹„ì¤‘</th>
          </tr>
        </thead>
        <tbody id="kr-tbody">
          <tr><td colspan="11" style="text-align:center; padding:24px; color:var(--muted);">ë¡œë”© ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â”€â”€ US Portfolio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section-title">
    <h2>í•´ì™¸ í¬íŠ¸í´ë¦¬ì˜¤</h2>
    <span class="tag">USD</span>
  </div>

  <div class="table-wrapper">
    <div class="table-header">
      <div class="table-header-left">
        <span class="market-badge us-badge">US</span>
        <span class="table-title">ë¯¸êµ­ ì£¼ì‹</span>
      </div>
      <div style="font-size:11px; color:var(--muted);" id="us-subtotal-header">â€”</div>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>ì¢…ëª©ëª…</th>
            <th>í‹°ì»¤</th>
            <th>ì„¹í„°</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>ë§¤ìˆ˜ë‹¨ê°€</th>
            <th>í˜„ì¬ê°€</th>
            <th>ì´ ë§¤ì… (USD)</th>
            <th>í‰ê°€ê¸ˆì•¡ (USD)</th>
            <th>ì†ìµ (USD)</th>
            <th>ìˆ˜ìµë¥ </th>
            <th>ë¹„ì¤‘</th>
          </tr>
        </thead>
        <tbody id="us-tbody">
          <tr><td colspan="11" style="text-align:center; padding:24px; color:var(--muted);">ë¡œë”© ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- â”€â”€ Sector Analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section-title">
    <h2>ì„¹í„° ë¶„ì„</h2>
    <span class="tag">ALLOCATION</span>
  </div>

  <div class="two-col">
    <!-- Donut Chart -->
    <div class="chart-card">
      <div class="chart-card-title">ì„¹í„°ë³„ ë¹„ì¤‘ (ë„ë„› ì°¨íŠ¸)</div>
      <div class="chart-container">
        <canvas id="sectorChart"></canvas>
      </div>
    </div>

    <!-- Sector Table -->
    <div class="chart-card">
      <div class="chart-card-title">ì„¹í„°ë³„ í‰ê°€ê¸ˆì•¡</div>
      <div id="sector-list-container">
        <div style="color:var(--muted); font-size:13px; text-align:center; padding:30px;">ë¡œë”© ì¤‘...</div>
      </div>
    </div>
  </div>

  <!-- â”€â”€ Transaction Log â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
  <div class="section-title">
    <h2>ë§¤ë§¤ ê¸°ë¡</h2>
    <span class="tag">TRANSACTION LOG</span>
  </div>

  <div class="table-wrapper">
    <div class="table-header">
      <div class="table-header-left">
        <span class="table-title">ìµœê·¼ ê±°ë˜ ë‚´ì—­</span>
      </div>
    </div>
    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th style="text-align:left;">ì¼ì</th>
            <th style="text-align:left;">ì¢…ëª©ëª…</th>
            <th style="text-align:left;">í‹°ì»¤</th>
            <th style="text-align:left;">êµ¬ë¶„</th>
            <th>ìˆ˜ëŸ‰</th>
            <th>ë‹¨ê°€</th>
            <th>ìˆ˜ìˆ˜ë£Œ</th>
            <th>ì´ê¸ˆì•¡</th>
            <th style="text-align:left;">ë©”ëª¨</th>
          </tr>
        </thead>
        <tbody id="tx-tbody">
          <tr><td colspan="9" style="text-align:center; padding:24px; color:var(--muted);">ë¡œë”© ì¤‘...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

</main>

<footer>
  <div>ICOK Fund íˆ¬ìì ê³µì‹œ ëŒ€ì‹œë³´ë“œ Â· ë°ì´í„° ì¶œì²˜: Google Sheets (GOOGLEFINANCE)</div>
  <div style="margin-top:4px; font-size:10px;">ë³¸ ì‚¬ì´íŠ¸ëŠ” íˆ¬ìì ì •ë³´ ê³µìœ  ëª©ì ìœ¼ë¡œ ì œì‘ë˜ì—ˆìœ¼ë©°, íˆ¬ì ê¶Œìœ ê°€ ì•„ë‹™ë‹ˆë‹¤.</div>
</footer>

<script>
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  CONFIG â€” êµ¬ê¸€ ì‹œíŠ¸ IDë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let SHEET_ID = localStorage.getItem('icok_sheet_id') || '';

const SECTOR_COLORS = [
  '#c8a96e','#4fa3e0','#3dd68c','#a78bfa','#fb7185',
  '#fbbf24','#34d399','#60a5fa','#f87171','#e879f9',
  '#2dd4bf','#f59e0b','#8b5cf6','#10b981','#3b82f6'
];

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  SAMPLE DATA (fallback)
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SAMPLE = {
  fx: 1446.19,
  krCash: 11015756,
  usCash: 1093.3,
  krStocks: [
    { name:'SKí•˜ì´ë‹‰ìŠ¤',    ticker:'000660', sector:'í…Œí¬',        qty:7,  avgPrice:607033, fee:14905, price:949000  },
    { name:'ì‚¼ì„±ì¤‘ê³µì—…',    ticker:'010140', sector:'ì¡°ì„  ë° ë°©ì‚°', qty:81, avgPrice:24769,  fee:5428,  price:29500   },
    { name:'ë¡œë³´í‹°ì¦ˆ',      ticker:'108490', sector:'ë¡œë´‡',        qty:5,  avgPrice:220550, fee:3155,  price:279500  },
    { name:'íš¨ì„±í‹°ì•¤ì”¨',    ticker:'298020', sector:'ì„ìœ í™”í•™',    qty:7,  avgPrice:381500, fee:6318,  price:393500  },
  ],
  usStocks: [
    { name:'ì•ŒíŒŒë²³ A',          ticker:'GOOGL', sector:'í…Œí¬', qty:6, avgPrice:300.09, fee:9.22,  price:314.98 },
    { name:'ë§ˆì´í¬ë¡  í…Œí¬ë†€ë¡œì§€', ticker:'MU',    sector:'í…Œí¬', qty:2, avgPrice:243.4,  fee:3.35,  price:428.17 },
  ],
  transactions: [
    { date:'2025-01-15', name:'SKí•˜ì´ë‹‰ìŠ¤',    ticker:'000660', type:'ë§¤ìˆ˜', qty:7,  price:607033, fee:14905, total:4263136, memo:'ì‹ ê·œ í¸ì…' },
    { date:'2025-01-16', name:'ì‚¼ì„±ì¤‘ê³µì—…',    ticker:'010140', type:'ë§¤ìˆ˜', qty:81, price:24769,  fee:5428,  total:2010697, memo:'í…Œë§ˆ í¸ì…' },
    { date:'2025-01-20', name:'ë¡œë³´í‹°ì¦ˆ',      ticker:'108490', type:'ë§¤ìˆ˜', qty:5,  price:220550, fee:3155,  total:1105905, memo:'ë¡œë´‡ í…Œë§ˆ' },
    { date:'2025-01-22', name:'íš¨ì„±í‹°ì•¤ì”¨',    ticker:'298020', type:'ë§¤ìˆ˜', qty:7,  price:381500, fee:6318,  total:2677818, memo:'ì„ìœ í™”í•™' },
    { date:'2025-02-03', name:'ì•ŒíŒŒë²³ A',      ticker:'GOOGL',  type:'ë§¤ìˆ˜', qty:6,  price:300.09, fee:9.22,  total:1809.76, memo:'í•´ì™¸ í¸ì…' },
    { date:'2025-02-05', name:'ë§ˆì´í¬ë¡  í…Œí¬', ticker:'MU',     type:'ë§¤ìˆ˜', qty:2,  price:243.4,  fee:3.35,  total:490.15,  memo:'ë°˜ë„ì²´' },
  ]
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  GViz FETCH HELPER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchSheet(sheetName) {
  const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=${encodeURIComponent(sheetName)}`;
  const res = await fetch(url);
  if (!res.ok) throw new Error(`HTTP ${res.status}`);
  const text = await res.text();
  // Strip JSONP wrapper: /*O_o*/\ngoogle.visualization.Query.setResponse({...});
  const jsonStr = text.replace(/^[^{]*/, '').replace(/\);?\s*$/, '');
  const json = JSON.parse(jsonStr);
  if (json.status === 'error') throw new Error(json.errors?.[0]?.message || 'Sheet error');
  return json.table;
}

function cellVal(row, colIdx) {
  if (!row || !row.c || row.c[colIdx] == null) return null;
  return row.c[colIdx]?.v ?? null;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PARSE Portfolio
//  â€» GViz APIëŠ” ë¹ˆ í–‰ì„ ì••ì¶•í•˜ë¯€ë¡œ í–‰ ë²ˆí˜¸ ê³ ì •ì´ ì•„ë‹Œ
//    ë ˆì´ë¸” ìŠ¤ìº” ë°©ì‹ìœ¼ë¡œ íŒŒì‹±í•©ë‹ˆë‹¤.
//  â€» ìˆ«ì í¬ë§·ì´ ì ìš©ëœ ì…€ì€ "1,445" ì²˜ëŸ¼ ì½¤ë§ˆ í¬í•¨
//    ë¬¸ìì—´ë¡œ ë°˜í™˜ë˜ë¯€ë¡œ parseNumìœ¼ë¡œ ì•ˆì „í•˜ê²Œ íŒŒì‹±í•©ë‹ˆë‹¤.
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

// ì½¤ë§ˆ í¬í•¨ ë¬¸ìì—´ / ì¼ë°˜ ìˆ«ì ëª¨ë‘ ì•ˆì „í•˜ê²Œ ë³€í™˜
function parseNum(v) {
  if (v === null || v === undefined) return 0;
  if (typeof v === 'number') return v;
  return parseFloat(String(v).replace(/,/g, '')) || 0;
}

function parsePortfolio(table) {
  const rows = table.rows;
  const getV = (r, c) => rows[r]?.c?.[c]?.v ?? null;

  // â”€â”€ ìš”ì•½ ì…€ ìŠ¤ìº” â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  let totalAumRow = -1, krCashRow = -1, usCashRow = -1, fxRow = -1;
  let krHeaderRow = -1, usHeaderRow = -1;

  for (let r = 0; r < rows.length; r++) {
    const label = String(getV(r, 0) || '');
    if (label.includes('í€ë“œ ì´ ê·œëª¨'))          totalAumRow = r;
    else if (label === 'êµ­ë‚´ ì˜ˆìˆ˜ê¸ˆ')             krCashRow   = r;
    else if (label.includes('ë¯¸êµ­ ì˜ˆìˆ˜ê¸ˆ (USD)')) usCashRow   = r;
    else if (label.includes('USD/KRW'))           fxRow       = r;
    else if (label === 'ì¢…ëª©ëª…') {
      if (krHeaderRow === -1) krHeaderRow = r;  // ì²« ë²ˆì§¸ â†’ êµ­ë‚´
      else                    usHeaderRow = r;  // ë‘ ë²ˆì§¸ â†’ í•´ì™¸
    }
  }

  // parseNumìœ¼ë¡œ ì½¤ë§ˆ í¬í•¨ ìˆ«ì ì•ˆì „ íŒŒì‹±
  const totalAum = parseNum(getV(totalAumRow, 1));
  const fx       = parseNum(getV(fxRow, 1))    || 1446;
  const krCash   = parseNum(getV(krCashRow, 1));
  const usCash   = parseNum(getV(usCashRow, 1));

  // â”€â”€ êµ­ë‚´ ì£¼ì‹ íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const krStocks = [];
  if (krHeaderRow >= 0) {
    const endRow = usHeaderRow >= 0 ? usHeaderRow : rows.length;
    for (let r = krHeaderRow + 1; r < endRow; r++) {
      const name = String(getV(r, 0) || '');
      if (!name || name.includes('ì†Œê³„') || name === 'ì¢…ëª©ëª…') continue;
      krStocks.push({
        name,
        ticker:   String(getV(r, 1) || '').replace(/KRX:|KOSDAQ:/gi, ''),
        sector:   String(getV(r, 2) || ''),
        qty:      parseNum(getV(r, 3)),
        avgPrice: parseNum(getV(r, 4)),
        fee:      parseNum(getV(r, 5)),
        purchase: parseNum(getV(r, 6)),
        price:    parseNum(getV(r, 7)),
        value:    parseNum(getV(r, 8)),
        pl:       parseNum(getV(r, 9)),
        plPct:    parseNum(getV(r, 10)),
        weight:   parseNum(getV(r, 11)),
      });
    }
  }

  // â”€â”€ í•´ì™¸ ì£¼ì‹ íŒŒì‹± â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const usStocks = [];
  if (usHeaderRow >= 0) {
    for (let r = usHeaderRow + 1; r < rows.length; r++) {
      const name = String(getV(r, 0) || '');
      if (!name || name.includes('ì†Œê³„') || name === 'ì¢…ëª©ëª…') continue;
      usStocks.push({
        name,
        ticker:   String(getV(r, 1) || ''),
        sector:   String(getV(r, 2) || ''),
        qty:      parseNum(getV(r, 3)),
        avgPrice: parseNum(getV(r, 4)),
        fee:      parseNum(getV(r, 5)),
        purchase: parseNum(getV(r, 6)),
        price:    parseNum(getV(r, 7)),
        value:    parseNum(getV(r, 8)),
        pl:       parseNum(getV(r, 9)),
        plPct:    parseNum(getV(r, 10)),
        weight:   parseNum(getV(r, 11)),
      });
    }
  }

  return { totalAum, fx, krCash, usCash, krStocks, usStocks };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PARSE Sector Summary
//  â€» GVizëŠ” ë¹ˆ í–‰Â·í—¤ë”í–‰ì„ ì••ì¶•í•˜ë¯€ë¡œ row 0ë¶€í„° ë°”ë¡œ ë°ì´í„°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseSectors(table) {
  const rows = table.rows;
  const sectors = [];
  for (let r = 0; r < rows.length; r++) {
    const row = rows[r];
    const name = row?.c?.[0]?.v;
    if (!name || name === 'ì„¹í„°' || name === 'ì„¹í„°ë³„ ë¹„ì¤‘ ë¶„ì„') continue;
    const value  = parseNum(row.c[1]?.v);
    const weight = parseNum(row.c[2]?.v);
    if (value > 0) sectors.push({ name: String(name), value, weight });
  }
  return sectors;
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  PARSE Transaction Log
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function parseTx(table) {
  const rows = table.rows;
  const txs = [];
  for (let r = 2; r < rows.length; r++) {
    const row = rows[r];
    if (!row?.c?.[0]?.v) continue;
    txs.push({
      date:   String(row.c[0].v || ''),
      name:   String(row.c[1]?.v || ''),
      ticker: String(row.c[2]?.v || '').replace(/KRX:|KOSDAQ:/gi, ''),
      type:   String(row.c[3]?.v || ''),
      qty:    parseFloat(row.c[4]?.v) || 0,
      price:  parseFloat(row.c[5]?.v) || 0,
      fee:    parseFloat(row.c[6]?.v) || 0,
      total:  parseFloat(row.c[7]?.v) || 0,
      memo:   String(row.c[8]?.v || ''),
    });
  }
  return txs.reverse(); // newest first
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  COMPUTE DERIVED VALUES
//  - ì‹¤ì œ ì‹œíŠ¸ ë°ì´í„°(GOOGLEFINANCE ê³„ì‚°ê°’ í¬í•¨)ë¥¼ ìš°ì„  ì‚¬ìš©
//  - ìƒ˜í”Œ ë°ì´í„°(purchase=0)ì¼ ë•Œë§Œ qtyÃ—priceë¡œ ì¬ê³„ì‚°
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeFromSample(data) {
  const { fx, krCash, usCash, krStocks, usStocks } = data;
  const sheetAum = data.totalAum || 0;

  // ìƒ˜í”Œ ë°ì´í„°ëŠ” purchaseê°€ 0ì´ë¯€ë¡œ ì§ì ‘ ê³„ì‚°
  krStocks.forEach(s => {
    if (!s.purchase) { s.purchase = s.qty * s.avgPrice + s.fee; }
    if (!s.value)    { s.value    = s.qty * s.price; }
    if (!s.pl)       { s.pl       = s.value - s.purchase; }
    if (!s.plPct)    { s.plPct    = s.purchase ? s.pl / s.purchase : 0; }
  });
  usStocks.forEach(s => {
    if (!s.purchase) { s.purchase = s.qty * s.avgPrice + s.fee; }
    if (!s.value)    { s.value    = s.qty * s.price; }
    if (!s.pl)       { s.pl       = s.value - s.purchase; }
    if (!s.plPct)    { s.plPct    = s.purchase ? s.pl / s.purchase : 0; }
  });

  const krValue       = krStocks.reduce((a, s) => a + s.value, 0);
  const usValue       = usStocks.reduce((a, s) => a + s.value, 0);  // USD
  const usValueKRW    = usValue * fx;
  const usCashKRW     = usCash * fx;

  // ì‹œíŠ¸ì— ì´ AUMì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ, ì—†ìœ¼ë©´ í•©ì‚°
  const totalAum = sheetAum || (krCash + usCashKRW + krValue + usValueKRW);

  const krPurchase    = krStocks.reduce((a, s) => a + s.purchase, 0);
  const usPurchaseKRW = usStocks.reduce((a, s) => a + s.purchase, 0) * fx;
  const totalPurchase = krPurchase + usPurchaseKRW;

  const krPl          = krStocks.reduce((a, s) => a + s.pl, 0);
  const usPl          = usStocks.reduce((a, s) => a + s.pl, 0) * fx;
  const totalPl       = krPl + usPl;
  const totalReturn   = totalPurchase ? totalPl / totalPurchase : 0;

  // ë¹„ì¤‘ ì¬ê³„ì‚° (ì‹œíŠ¸ê°’ì´ ìˆìœ¼ë©´ ê·¸ëŒ€ë¡œ ì‚¬ìš©)
  krStocks.forEach(s => {
    if (!s.weight) s.weight = totalAum ? s.value / totalAum : 0;
  });
  usStocks.forEach(s => {
    if (!s.weight) s.weight = totalAum ? (s.value * fx) / totalAum : 0;
  });

  // ì„¹í„° ì§‘ê³„ (Sector Summary ì‹œíŠ¸ê°€ ì—†ì„ ë•Œ í´ë°±ìš©)
  const sectorMap = {};
  krStocks.forEach(s => { sectorMap[s.sector] = (sectorMap[s.sector] || 0) + s.value; });
  usStocks.forEach(s => { sectorMap[s.sector] = (sectorMap[s.sector] || 0) + s.value * fx; });
  const sectors = Object.entries(sectorMap)
    .map(([name, value]) => ({ name, value, weight: totalAum ? value / totalAum : 0 }))
    .filter(s => s.value > 0);

  return { fx, krCash, usCash, usCashKRW, krStocks, usStocks,
           totalAum, totalPl, totalReturn, totalPurchase, sectors };
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  FORMAT HELPERS
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const fmt = {
  krw: v => v == null ? 'â€”' : (v < 0 ? '-' : '') + 'â‚©' + Math.abs(Math.round(v)).toLocaleString(),
  usd: v => v == null ? 'â€”' : (v < 0 ? '-' : '') + '$' + Math.abs(v).toLocaleString('en-US', {minimumFractionDigits:2, maximumFractionDigits:2}),
  pct: v => v == null ? 'â€”' : (v >= 0 ? '+' : '') + (v * 100).toFixed(2) + '%',
  num: v => v == null ? 'â€”' : v.toLocaleString(),
  date: v => {
    if (!v) return 'â€”';
    // Handle gviz Date format: Date(yyyy,mm-1,dd)
    const m = String(v).match(/Date\((\d+),(\d+),(\d+)\)/);
    if (m) {
      const d = new Date(parseInt(m[1]), parseInt(m[2]), parseInt(m[3]));
      return d.toLocaleDateString('ko-KR', {year:'numeric',month:'2-digit',day:'2-digit'});
    }
    return String(v).split('T')[0];
  }
};

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  RENDER
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let sectorChartInstance = null;

function renderKPIs(d) {
  document.getElementById('kpi-aum').textContent    = fmt.krw(d.totalAum);
  document.getElementById('kpi-aum-sub').textContent = `ì˜ˆìˆ˜ê¸ˆ êµ­ë‚´ ${fmt.krw(d.krCash)} / í•´ì™¸ $${d.usCash?.toFixed(0)}`;

  const plEl = document.getElementById('kpi-pl');
  plEl.textContent = fmt.krw(d.totalPl);
  plEl.className = 'kpi-value ' + (d.totalPl >= 0 ? 'pos' : 'neg');
  document.getElementById('kpi-pl-sub').textContent = `ì´ ë§¤ì… ëŒ€ë¹„ ${fmt.pct(d.totalReturn)}`;

  const retEl = document.getElementById('kpi-return');
  retEl.textContent = fmt.pct(d.totalReturn);
  retEl.className = 'kpi-value ' + (d.totalReturn >= 0 ? 'pos' : 'neg');

  document.getElementById('kpi-fx').textContent  = d.fx ? Math.round(d.fx).toLocaleString('ko-KR') : 'â€”';
  document.getElementById('kpi-cash').textContent = `USD í˜„ê¸ˆ ${fmt.krw(d.usCashKRW || d.usCash * d.fx)}`;
}

function renderKrTable(stocks, totalAum) {
  const tbody = document.getElementById('kr-tbody');
  if (!stocks.length) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:24px;color:var(--muted);">ë°ì´í„° ì—†ìŒ</td></tr>';
    return;
  }

  let totalPurchase = 0, totalValue = 0, totalPl = 0;
  stocks.forEach(s => { totalPurchase += s.purchase; totalValue += s.value; totalPl += s.pl; });

  tbody.innerHTML = stocks.map(s => `
    <tr>
      <td>${s.name}</td>
      <td><span class="ticker-chip">${s.ticker}</span></td>
      <td><span class="sector-chip">${s.sector}</span></td>
      <td>${fmt.num(s.qty)}</td>
      <td>${fmt.krw(s.avgPrice)}</td>
      <td>${fmt.krw(s.price)}</td>
      <td>${fmt.krw(s.purchase)}</td>
      <td>${fmt.krw(s.value)}</td>
      <td class="${s.pl >= 0 ? 'pos-text' : 'neg-text'}">${fmt.krw(s.pl)}</td>
      <td class="${s.plPct >= 0 ? 'pos-text' : 'neg-text'}">${fmt.pct(s.plPct)}</td>
      <td class="muted-text">${(s.weight * 100).toFixed(1)}%</td>
    </tr>
  `).join('') + `
    <tr class="subtotal-row">
      <td colspan="6">êµ­ë‚´ ì†Œê³„</td>
      <td>${fmt.krw(totalPurchase)}</td>
      <td>${fmt.krw(totalValue)}</td>
      <td class="${totalPl >= 0 ? 'pos-text' : 'neg-text'}">${fmt.krw(totalPl)}</td>
      <td class="${totalPl >= 0 ? 'pos-text' : 'neg-text'}">${fmt.pct(totalPurchase ? totalPl/totalPurchase : 0)}</td>
      <td class="muted-text">${totalAum ? ((totalValue/totalAum)*100).toFixed(1) : 0}%</td>
    </tr>
  `;

  document.getElementById('kr-subtotal-header').textContent =
    `í‰ê°€ê¸ˆì•¡ ${fmt.krw(totalValue)} (${fmt.pct(totalPurchase ? totalPl/totalPurchase : 0)})`;
}

function renderUsTable(stocks, fx, totalAum) {
  const tbody = document.getElementById('us-tbody');
  if (!stocks.length) {
    tbody.innerHTML = '<tr><td colspan="11" style="text-align:center;padding:24px;color:var(--muted);">ë°ì´í„° ì—†ìŒ</td></tr>';
    return;
  }

  let totalPurchase = 0, totalValue = 0, totalPl = 0;
  stocks.forEach(s => { totalPurchase += s.purchase; totalValue += s.value; totalPl += s.pl; });

  tbody.innerHTML = stocks.map(s => `
    <tr>
      <td>${s.name}</td>
      <td><span class="ticker-chip" style="color:var(--us-blue)">${s.ticker}</span></td>
      <td><span class="sector-chip">${s.sector}</span></td>
      <td>${fmt.num(s.qty)}</td>
      <td>${fmt.usd(s.avgPrice)}</td>
      <td>${fmt.usd(s.price)}</td>
      <td>${fmt.usd(s.purchase)}</td>
      <td>${fmt.usd(s.value)}</td>
      <td class="${s.pl >= 0 ? 'pos-text' : 'neg-text'}">${fmt.usd(s.pl)}</td>
      <td class="${s.plPct >= 0 ? 'pos-text' : 'neg-text'}">${fmt.pct(s.plPct)}</td>
      <td class="muted-text">${(s.weight * 100).toFixed(1)}%</td>
    </tr>
  `).join('') + `
    <tr class="subtotal-row">
      <td colspan="6">ë¯¸êµ­ ì†Œê³„</td>
      <td>${fmt.usd(totalPurchase)}</td>
      <td>${fmt.usd(totalValue)}</td>
      <td class="${totalPl >= 0 ? 'pos-text' : 'neg-text'}">${fmt.usd(totalPl)}</td>
      <td class="${totalPl >= 0 ? 'pos-text' : 'neg-text'}">${fmt.pct(totalPurchase ? totalPl/totalPurchase : 0)}</td>
      <td class="muted-text">${totalAum ? (((totalValue*fx)/totalAum)*100).toFixed(1) : 0}%</td>
    </tr>
  `;

  const valueKRW = totalValue * fx;
  document.getElementById('us-subtotal-header').textContent =
    `í‰ê°€ê¸ˆì•¡ ${fmt.usd(totalValue)} (â‰ˆ ${fmt.krw(valueKRW)})`;
}

function renderSectors(sectors) {
  const labels  = sectors.map(s => s.name);
  const values  = sectors.map(s => s.value);
  const colors  = SECTOR_COLORS.slice(0, sectors.length);

  // Chart
  const ctx = document.getElementById('sectorChart').getContext('2d');
  if (sectorChartInstance) sectorChartInstance.destroy();

  sectorChartInstance = new Chart(ctx, {
    type: 'doughnut',
    data: {
      labels,
      datasets: [{
        data: values,
        backgroundColor: colors,
        borderColor: '#161a22',
        borderWidth: 3,
        hoverOffset: 8,
      }]
    },
    options: {
      cutout: '62%',
      plugins: {
        legend: { display: false },
        tooltip: {
          callbacks: {
            label: ctx => {
              const total = ctx.dataset.data.reduce((a, b) => a + b, 0);
              const pct   = total ? ((ctx.parsed / total) * 100).toFixed(1) : 0;
              return ` ${ctx.label}: ${fmt.krw(ctx.parsed)} (${pct}%)`;
            }
          }
        }
      },
      animation: { animateRotate: true, duration: 800 }
    }
  });

  // Table
  const total = values.reduce((a, b) => a + b, 0);
  const container = document.getElementById('sector-list-container');
  container.innerHTML = `<div class="sector-list">` +
    sectors.map((s, i) => {
      const pct = total ? (s.value / total * 100) : 0;
      return `
        <div class="sector-row">
          <div class="sector-dot" style="background:${colors[i]}"></div>
          <div class="sector-name">${s.name}</div>
          <div class="sector-bar-wrap">
            <div class="sector-bar" style="width:${pct}%;background:${colors[i]}"></div>
          </div>
          <div class="sector-pct">${pct.toFixed(1)}%</div>
          <div class="sector-amount">${fmt.krw(s.value)}</div>
        </div>
      `;
    }).join('') + `</div>`;
}

function renderTx(transactions) {
  const tbody = document.getElementById('tx-tbody');
  if (!transactions.length) {
    tbody.innerHTML = '<tr><td colspan="9" style="text-align:center;padding:24px;color:var(--muted);">ê±°ë˜ ê¸°ë¡ ì—†ìŒ</td></tr>';
    return;
  }

  tbody.innerHTML = transactions.slice(0, 20).map(t => `
    <tr class="tx-row">
      <td style="text-align:left;">${fmt.date(t.date)}</td>
      <td style="text-align:left;">${t.name}</td>
      <td style="text-align:left;"><span class="ticker-chip">${t.ticker}</span></td>
      <td style="text-align:left;" class="${t.type === 'ë§¤ìˆ˜' ? 'tx-buy' : 'tx-sell'}">${t.type}</td>
      <td>${fmt.num(t.qty)}</td>
      <td>${t.price > 1000 ? fmt.krw(t.price) : fmt.usd(t.price)}</td>
      <td>${t.price > 1000 ? fmt.krw(t.fee) : fmt.usd(t.fee)}</td>
      <td>${t.price > 1000 ? fmt.krw(t.total) : fmt.usd(t.total)}</td>
      <td style="text-align:left;color:var(--muted);">${t.memo || 'â€”'}</td>
    </tr>
  `).join('');
}

function setStatus(type, text) {
  const badge = document.getElementById('status-badge');
  badge.className = `badge-${type}`;
  badge.innerHTML = `<span class="dot"></span><span>${text}</span>`;
}

function setUpdateTime() {
  const now = new Date();
  document.getElementById('update-time').textContent =
    now.toLocaleDateString('ko-KR') + ' ' +
    now.toLocaleTimeString('ko-KR', {hour:'2-digit', minute:'2-digit'});
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  MAIN LOAD
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function loadData() {
  setStatus('loading', 'ë°ì´í„° ë¡œë”© ì¤‘...');

  if (!SHEET_ID) {
    showSampleData();
    return;
  }

  try {
    const [portTable, sectorTable, txTable] = await Promise.all([
      fetchSheet('Portfolio'),
      fetchSheet('Sector Summary'),
      fetchSheet('Transaction Log'),
    ]);

    const portData   = parsePortfolio(portTable);
    const sectors    = parseSectors(sectorTable);
    const txData     = parseTx(txTable);
    const computed   = computeFromSample(portData); // compute totals

    // Override sectors with live data if available
    const liveSectors = sectors.length ? sectors : computed.sectors;

    renderKPIs(computed);
    renderKrTable(computed.krStocks, computed.totalAum);
    renderUsTable(computed.usStocks, computed.fx, computed.totalAum);
    renderSectors(liveSectors);
    renderTx(txData.length ? txData : SAMPLE.transactions);

    document.getElementById('error-banner').style.display = 'none';
    setStatus('live', 'ë¼ì´ë¸Œ ë°ì´í„°');
    setUpdateTime();
    document.getElementById('config-panel').style.display = 'none';

  } catch (err) {
    console.error('Sheet fetch error:', err);
    showSampleData();
  }
}

function showSampleData() {
  const d = computeFromSample(SAMPLE);
  renderKPIs(d);
  renderKrTable(d.krStocks, d.totalAum);
  renderUsTable(d.usStocks, d.fx, d.totalAum);
  renderSectors(d.sectors);
  renderTx(SAMPLE.transactions);
  document.getElementById('error-banner').style.display = SHEET_ID ? 'block' : 'none';
  setStatus('error', SHEET_ID ? 'ì—°ê²° ì˜¤ë¥˜ (ìƒ˜í”Œ í‘œì‹œ)' : 'ì‹œíŠ¸ ë¯¸ì—°ê²° (ìƒ˜í”Œ í‘œì‹œ)');
  setUpdateTime();
}

function applySheetId() {
  const input = document.getElementById('sheet-id-input').value.trim();
  // Extract ID from URL if pasted
  const urlMatch = input.match(/\/spreadsheets\/d\/([a-zA-Z0-9_-]+)/);
  SHEET_ID = urlMatch ? urlMatch[1] : input;
  if (SHEET_ID) {
    localStorage.setItem('icok_sheet_id', SHEET_ID);
    document.getElementById('sheet-id-input').value = SHEET_ID;
    loadData();
  }
}

// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
//  INIT
// â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.addEventListener('DOMContentLoaded', () => {
  // Restore saved sheet ID
  if (SHEET_ID) {
    document.getElementById('sheet-id-input').value = SHEET_ID;
  }
  loadData();
});
</script>
</body>
</html>
